name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ==========================================================================
  # TypeScript Track (Primary)
  # ==========================================================================
  typescript:
    name: TypeScript
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: typescript

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Type check
        run: pnpm typecheck

      - name: Build
        run: pnpm build

      - name: Test
        run: pnpm test

  # ==========================================================================
  # Game Compatibility Check
  # ==========================================================================
  games:
    name: Game Compatibility
    runs-on: ubuntu-latest
    needs: typescript

    defaults:
      run:
        working-directory: typescript

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build all packages
        run: pnpm build

      - name: Validate example-headless boots
        run: |
          cd games/example-headless
          npx tsx src/index.ts | head -20
          echo "✓ example-headless boots successfully"

      - name: Validate all game.json files
        run: |
          for game in games/*/game.json; do
            echo "Validating $game..."
            node -e "
              const fs = require('fs');
              const config = JSON.parse(fs.readFileSync('$game', 'utf-8'));
              if (!config.id) throw new Error('Missing id');
              if (!config.engineApiVersion) throw new Error('Missing engineApiVersion');
              console.log('  ✓ Valid');
            "
          done

  # ==========================================================================
  # Plugin Validation
  # ==========================================================================
  plugins:
    name: Plugin Validation
    runs-on: ubuntu-latest
    needs: typescript

    defaults:
      run:
        working-directory: typescript

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Validate all plugin.json files
        run: |
          for plugin in plugins/*/plugin.json; do
            if [[ "$plugin" == *"_template"* ]]; then
              echo "Skipping template: $plugin"
              continue
            fi
            echo "Validating $plugin..."
            node -e "
              const fs = require('fs');
              const config = JSON.parse(fs.readFileSync('$plugin', 'utf-8'));
              if (!config.id) throw new Error('Missing id');
              if (!config.engineApiVersion) throw new Error('Missing engineApiVersion');
              if (!config.status) throw new Error('Missing status');
              if (!['experimental', 'stable', 'deprecated'].includes(config.status)) {
                throw new Error('Invalid status: ' + config.status);
              }
              console.log('  ✓ Valid');
            "
          done

  # ==========================================================================
  # Python Track (Experimental - Optional)
  # ==========================================================================
  python:
    name: Python (Experimental)
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the build if Python track fails

    defaults:
      run:
        working-directory: python

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check Python structure
        run: |
          echo "Python track structure check..."
          if [ -f "pyproject.toml" ]; then
            echo "✓ pyproject.toml exists"
          else
            echo "⚠ pyproject.toml not found (Python track not yet implemented)"
          fi
